<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pdftools</title>
    <script>
      // Debug logging
      console.log("Loading PDF libraries...");

      // Try to load pdf-lib-with-encrypt from the correct CDN
      const script = document.createElement("script");
      script.src =
        "https://unpkg.com/pdf-lib-with-encrypt@1.2.1/dist/pdf-lib.min.js";
      script.onload = function () {
        console.log("pdf-lib-with-encrypt loaded successfully");
        console.log("PDFLib available:", typeof PDFLib !== "undefined");
        if (typeof PDFLib !== "undefined") {
          console.log("PDFLib methods:", Object.keys(PDFLib));
        }
      };
      script.onerror = function () {
        console.error(
          "Failed to load pdf-lib-with-encrypt, falling back to regular pdf-lib"
        );
        // Fallback to regular pdf-lib
        const fallbackScript = document.createElement("script");
        fallbackScript.src =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js";
        fallbackScript.onload = function () {
          console.log("Regular pdf-lib loaded as fallback");
          console.log("PDFLib available:", typeof PDFLib !== "undefined");
        };
        document.head.appendChild(fallbackScript);
      };
      document.head.appendChild(script);
    </script>

    <!-- PyScript for Python in browser -->
    <link
      rel="stylesheet"
      href="https://pyscript.net/releases/2024.1.1/core.css"
    />
    <script
      type="module"
      src="https://pyscript.net/releases/2024.1.1/core.js"
    ></script>

    <!-- PyScript configuration -->
    <py-config> packages = ["pypdf"] </py-config>

    <!-- Python script for PDF password protection -->
    <!-- prettier-ignore -->
    <py-script>
from pypdf import PdfReader, PdfWriter 
from js import console, Uint8Array
import io 

def encrypt_pdf_with_password(pdf_bytes, password): 
    try:
        console.log("Python: Starting PDF encryption") 
        pdf_data = bytes(pdf_bytes)
        console.log(f"Python: PDF data length: {len(pdf_data)}") 
        pdf_stream = io.BytesIO(pdf_data) 
        reader = PdfReader(pdf_stream) 
        console.log(f"Python: PDF has {len(reader.pages)} pages") 
        
        writer = PdfWriter() 
        for page in reader.pages: 
            writer.add_page(page) 
        
        writer.encrypt(password)
        console.log("Python: PDF encrypted successfully") 
        
        output_stream = io.BytesIO() 
        writer.write(output_stream) 
        encrypted_bytes = output_stream.getvalue() 
        console.log(f"Python: Encrypted PDF length: {len(encrypted_bytes)}") 
        
        return Uint8Array.new(encrypted_bytes) 
        
    except Exception as e: 
        console.error(f"Python encryption error: {str(e)}") 
        raise e 

from pyscript import window 
window.encrypt_pdf_with_password = encrypt_pdf_with_password
     </py-script>

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="title-container">
        <h1 class="title">pdftools<span class="underscore">_</span></h1>
        <h1 class="subtitle">magnus.to</h1>
      </div>

      <div class="upload-section-container">
        <div class="upload-section" id="uploadSection">
          <p style="margin-bottom: 20px; font-size: 18px">
            Drop your PDF file here or click to browse
          </p>
          <button class="upload-btn" id="chooseFileBtn">click</button>
          <input type="file" id="fileInput" accept=".pdf" />
        </div>
        <div id="fileInfo"></div>
      </div>
      <div id="status"></div>

      <div class="operations-grid" id="operationsGrid" style="display: none">
        <!-- Password Protection -->
        <div class="operation-card">
          <h3>password</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="enablePassword" />
            <label for="enablePassword">Password protect PDF</label>
          </div>
          <div id="passwordGroup" style="display: none">
            <div class="form-group">
              <label for="pdfPassword">Password:</label>
              <input
                type="password"
                id="pdfPassword"
                placeholder="Enter password"
              />
              <small
                style="
                  color: #999;
                  font-size: 11px;
                  display: block;
                  margin-top: 2px;
                "
              >
                Python PyPDF encryption - most reliable method
              </small>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm password:</label>
              <input
                type="password"
                id="confirmPassword"
                placeholder="Confirm password"
              />
            </div>
            <div
              style="
                margin-top: 10px;
                padding: 8px;
                background: #2347b8;
                border: 1px solid #f9fefb;
                font-size: 11px;
                line-height: 1.4;
              "
            >
              <strong>ðŸ”’ Python PyPDF Encryption:</strong><br />
              Uses PyScript to run Python in the browser with PyPDF library for
              reliable PDF encryption. Creates standard password-protected PDFs
              that work with any PDF viewer.
              <br /><br />
              <strong>Fallback:</strong> JavaScript PDF-lib if Python fails
            </div>
          </div>
        </div>

        <!-- Page Rotation -->
        <div class="operation-card">
          <h3>rotate</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="enableRotation" />
            <label for="enableRotation">Enable page rotation</label>
          </div>
          <div id="rotationGroup" style="display: none">
            <div class="form-group">
              <label for="rotationAngle">Rotation angle:</label>
              <select id="rotationAngle">
                <option value="90">90Â° (Clockwise)</option>
                <option value="180">180Â° (Upside down)</option>
                <option value="270">270Â° (Counter-clockwise)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="rotationPages">Pages to rotate:</label>
              <select id="rotationPages">
                <option value="all">All pages</option>
                <option value="landscape">Only landscape pages</option>
                <option value="portrait">Only portrait pages</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Page Numbers -->
        <div class="operation-card">
          <h3>page numbers</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="enablePageNumbers" />
            <label for="enablePageNumbers">Add page numbers</label>
          </div>
          <div id="pageNumberGroup" style="display: none">
            <div class="form-group">
              <label for="pageNumberPosition">Position:</label>
              <select id="pageNumberPosition">
                <option value="bottom-center">Bottom Center</option>
                <option value="bottom-right">Bottom Right</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="top-center">Top Center</option>
                <option value="top-right">Top Right</option>
                <option value="top-left">Top Left</option>
              </select>
            </div>
            <div class="form-group">
              <label for="pageNumberSize">Font size:</label>
              <input
                type="number"
                id="pageNumberSize"
                value="12"
                min="8"
                max="24"
              />
            </div>
            <div class="form-group">
              <label for="startPage">Start numbering from:</label>
              <input type="number" id="startPage" value="1" min="1" />
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="keepNumbersAtBottom" />
              <label for="keepNumbersAtBottom"
                >Keep page numbers at bottom after rotation</label
              >
            </div>
          </div>
        </div>

        <!-- PDF Merge -->
        <div class="operation-card">
          <h3>merge</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="enableMerge" />
            <label for="enableMerge">Merge with other PDFs</label>
          </div>
          <div class="form-group" id="mergeGroup" style="display: none">
            <label for="mergeFiles">Select PDFs to merge:</label>
            <input type="file" id="mergeFiles" accept=".pdf" multiple />
            <small style="color: #666; font-size: 12px">
              Files will be merged in the order selected
            </small>
          </div>
        </div>

        <!-- PDF Split -->
        <div class="operation-card">
          <h3>split</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="enableSplit" />
            <label for="enableSplit">Split PDF</label>
          </div>
          <div id="splitGroup" style="display: none">
            <div class="form-group">
              <label for="splitType">Split method:</label>
              <select id="splitType">
                <option value="individual">Individual pages</option>
                <option value="ranges">Custom ranges</option>
                <option value="evenodd">Even/Odd pages</option>
              </select>
            </div>
            <div class="form-group" id="splitRangesGroup" style="display: none">
              <label for="splitRanges">Page ranges (e.g., 1-3, 5, 7-10):</label>
              <input type="text" id="splitRanges" placeholder="1-3, 5, 7-10" />
            </div>
          </div>
        </div>

        <!-- Watermark -->
        <div class="operation-card">
          <h3>watermark</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="enableWatermark" />
            <label for="enableWatermark">Add watermark</label>
          </div>
          <div id="watermarkGroup" style="display: none">
            <div class="form-group">
              <label for="watermarkType">Watermark type:</label>
              <select id="watermarkType">
                <option value="text">Text</option>
                <option value="image">Image</option>
              </select>
            </div>
            <div id="textWatermarkGroup">
              <div class="form-group">
                <label for="watermarkText">Text:</label>
                <input
                  type="text"
                  id="watermarkText"
                  placeholder="Enter watermark text"
                />
              </div>
              <div class="form-group">
                <label for="watermarkFontSize">Font size:</label>
                <input
                  type="number"
                  id="watermarkFontSize"
                  value="24"
                  min="8"
                  max="72"
                />
              </div>
              <div class="form-group">
                <label for="watermarkColor">Color:</label>
                <input type="color" id="watermarkColor" value="#cccccc" />
              </div>
              <div class="form-group">
                <label for="watermarkRotation">Rotation (degrees):</label>
                <input
                  type="number"
                  id="watermarkRotation"
                  value="45"
                  min="-360"
                  max="360"
                />
              </div>
            </div>
            <div id="imageWatermarkGroup" style="display: none">
              <div class="form-group">
                <label for="watermarkImage">Select image:</label>
                <input
                  type="file"
                  id="watermarkImage"
                  accept=".jpg,.jpeg,.png"
                />
              </div>
              <div class="form-group">
                <label for="watermarkImageScale">Scale (0.1 - 2.0):</label>
                <input
                  type="number"
                  id="watermarkImageScale"
                  value="0.3"
                  min="0.1"
                  max="2.0"
                  step="0.1"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="watermarkPosition">Position:</label>
              <select id="watermarkPosition">
                <option value="center">Center</option>
                <option value="top-left">Top Left</option>
                <option value="top-right">Top Right</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="bottom-right">Bottom Right</option>
                <option value="top-center">Top Center</option>
                <option value="bottom-center">Bottom Center</option>
              </select>
            </div>
            <div class="form-group">
              <label for="watermarkOpacity">Opacity (0.1 - 1.0):</label>
              <input
                type="number"
                id="watermarkOpacity"
                value="0.3"
                min="0.1"
                max="1.0"
                step="0.1"
              />
            </div>
          </div>
        </div>

        <!-- Compression -->
        <div class="operation-card">
          <h3>compress</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="enableCompression" />
            <label for="enableCompression">Compress PDF</label>
          </div>
          <div id="compressionGroup" style="display: none">
            <div class="form-group">
              <label for="compressionLevel">Compression level:</label>
              <select id="compressionLevel">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="removeMetadata" checked />
              <label for="removeMetadata">Remove metadata</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="optimizeImages" />
              <label for="optimizeImages">Optimize images</label>
            </div>
          </div>
        </div>
        <div class="operation-card">
          <h3>more tools?</h3>
        </div>
      </div>

      <button class="process-btn" id="processBtn" style="display: none">
        Process
      </button>

      <div class="download-section" id="downloadSection" style="display: none">
        <button class="download-btn" id="downloadBtn">Download</button>
        <div id="splitDownloadSection" style="display: none; margin-top: 15px">
          <p style="margin-bottom: 10px; color: #666">
            Split files ready for download:
          </p>
          <div id="splitDownloadLinks"></div>
        </div>
      </div>
    </div>

    <script type="module" src="script.js"></script>
  </body>
</html>
